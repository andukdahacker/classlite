generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/client"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String    @id @default(cuid())
  email               String?   @unique
  name                String?
  avatarUrl           String?   @map("avatar_url")
  phoneNumber         String?   @map("phone_number")
  preferredLanguage   String    @default("en") @map("preferred_language")
  deletionRequestedAt          DateTime? @map("deletion_requested_at")
  emailScheduleNotifications   Boolean   @default(true) @map("email_schedule_notifications")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  authAccounts      AuthAccount[]
  memberships       CenterMembership[]
  classes           ClassStudent[]
  notifications     Notification[]
  teachingClasses   Class[]            @relation("ClassTeacher")
  csvImportLogs     CsvImportLog[]     @relation("CsvImportUser")
  attendanceRecords Attendance[]       @relation("AttendanceStudent")
  attendanceMarked  Attendance[]       @relation("AttendanceMarker")
  emailLogs         EmailLog[]
  exercises         Exercise[]         @relation("ExerciseCreator")
  createdMockTests    MockTest[]         @relation("MockTestCreatedBy")
  createdAssignments  Assignment[]       @relation("AssignmentCreator")
  studentAssignments  AssignmentStudent[] @relation("AssignmentStudents")
  submissions         Submission[]
  teacherComments     TeacherComment[]

  @@map("user")
}

model AuthAccount {
  id             String       @id @default(cuid())
  userId         String       @map("user_id")
  provider       AuthProvider
  providerUserId String       @map("provider_user_id")
  email          String?

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@unique([provider, email])
  @@map("auth_account")
}

enum AuthProvider {
  FIREBASE
}

model Center {
  id   String @id @default(cuid())
  name String
  slug String @unique

  logoUrl    String? @map("logo_url")
  timezone   String  @default("UTC")
  brandColor String  @default("#2563EB") @map("brand_color")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  memberships    CenterMembership[]
  csvImportLogs  CsvImportLog[]

  @@map("center")
}

model CenterMembership {
  id       String           @id @default(cuid())
  centerId String           @map("center_id")
  userId   String           @map("user_id")
  role     CenterRole
  status   MembershipStatus @default(ACTIVE)

  createdAt DateTime @default(now()) @map("created_at")

  center                Center                 @relation(fields: [centerId], references: [id], onDelete: Cascade)
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  membershipPermissions MembershipPermission[]

  @@unique([centerId, userId])
  @@unique([id, centerId])
  @@map("center_membership")
}

enum CenterRole {
  OWNER
  ADMIN
  TEACHER
  STUDENT
}

enum MembershipStatus {
  INVITED
  ACTIVE
  SUSPENDED
}

model Permission {
  id   String @id @default(cuid())
  key  String @unique // e.g., "center.update", "user.invite"
  name String

  rolePermissions       RolePermission[]
  membershipPermissions MembershipPermission[]

  @@map("permission")
}

model RolePermission {
  role         CenterRole
  permissionId String     @map("permission_id")

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([role, permissionId])
  @@map("role_permission")
}

model MembershipPermission {
  id           String  @id @default(cuid())
  membershipId String  @map("membership_id")
  permissionId String  @map("permission_id")
  allowed      Boolean

  membership CenterMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  permission Permission       @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([membershipId, permissionId])
  @@map("membership_permission")
}

model Course {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?
  centerId    String   @map("center_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  classes Class[]

  @@unique([id, centerId])
  @@index([centerId])
  @@map("course")
}

model Class {
  id              String   @id @default(cuid())
  name            String
  courseId        String   @map("course_id")
  teacherId       String?  @map("teacher_id")
  defaultRoomName String?  @map("default_room_name")
  centerId        String   @map("center_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  course    Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher   User?           @relation("ClassTeacher", fields: [teacherId], references: [id], onDelete: SetNull)
  students    ClassStudent[]
  schedules   ClassSchedule[]
  sessions    ClassSession[]
  assignments Assignment[]

  @@unique([id, centerId])
  @@index([centerId])
  @@index([courseId])
  @@index([teacherId])
  @@map("class")
}

model ClassStudent {
  classId   String @map("class_id")
  studentId String @map("student_id")
  centerId  String @map("center_id")

  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@id([classId, studentId])
  @@index([centerId])
  @@map("class_student")
}

model ClassSchedule {
  id        String  @id @default(cuid())
  classId   String  @map("class_id")
  dayOfWeek Int     @map("day_of_week") // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime String  @map("start_time") // HH:mm format
  endTime   String  @map("end_time") // HH:mm format
  roomName  String? @map("room_name")
  centerId  String  @map("center_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  class    Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  sessions ClassSession[]

  @@unique([id, centerId])
  @@index([centerId])
  @@index([classId])
  @@map("class_schedule")
}

model ClassSession {
  id         String        @id @default(cuid())
  classId    String        @map("class_id")
  scheduleId String?       @map("schedule_id")
  startTime  DateTime      @map("start_time")
  endTime    DateTime      @map("end_time")
  roomName   String?       @map("room_name")
  status     SessionStatus @default(SCHEDULED)
  centerId   String        @map("center_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  class      Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  schedule   ClassSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  attendance Attendance[]

  @@unique([id, centerId])
  @@index([centerId])
  @@index([classId])
  @@index([scheduleId])
  @@index([startTime, endTime])
  @@map("class_session")
}

enum SessionStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

model Attendance {
  id        String           @id @default(cuid())
  sessionId String           @map("session_id")
  studentId String           @map("student_id")
  status    AttendanceStatus
  markedBy  String           @map("marked_by")
  centerId  String           @map("center_id")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  session ClassSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student User         @relation("AttendanceStudent", fields: [studentId], references: [id])
  marker  User         @relation("AttendanceMarker", fields: [markedBy], references: [id])

  @@unique([sessionId, studentId])
  @@index([studentId, centerId])
  @@index([sessionId])
  @@map("attendance")
}

model Room {
  id        String   @id @default(cuid())
  name      String
  centerId  String   @map("center_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([name, centerId])
  @@index([centerId])
  @@map("room")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  centerId  String   @map("center_id")
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([centerId])
  @@index([userId])
  @@index([userId, read])
  @@map("notification")
}

model LoginAttempt {
  id          String    @id @default(cuid())
  email       String    @unique
  attempts    Int       @default(0)
  lockedUntil DateTime? @map("locked_until")
  lastAttempt DateTime? @map("last_attempt")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("login_attempt")
}

model CsvImportLog {
  id            String          @id @default(cuid())
  centerId      String          @map("center_id")
  importedById  String          @map("imported_by_id")
  fileName      String          @map("file_name")
  totalRows     Int             @map("total_rows")
  validRows     Int             @map("valid_rows")
  duplicateRows Int             @map("duplicate_rows")
  errorRows     Int             @map("error_rows")
  importedRows  Int             @default(0) @map("imported_rows")
  failedRows    Int             @default(0) @map("failed_rows")
  status        CsvImportStatus @default(PENDING)
  jobId         String?         @map("job_id")
  createdAt     DateTime        @default(now()) @map("created_at")
  completedAt   DateTime?       @map("completed_at")

  center     Center            @relation(fields: [centerId], references: [id], onDelete: Cascade)
  importedBy User              @relation("CsvImportUser", fields: [importedById], references: [id], onDelete: Cascade)
  rows       CsvImportRowLog[]

  @@index([centerId])
  @@index([status])
  @@map("csv_import_log")
}

model CsvImportRowLog {
  id           String             @id @default(cuid())
  importLogId  String             @map("import_log_id")
  rowNumber    Int                @map("row_number")
  email        String
  name         String
  role         String
  status       CsvImportRowStatus
  errorMessage String?            @map("error_message")

  importLog CsvImportLog @relation(fields: [importLogId], references: [id], onDelete: Cascade)

  @@index([importLogId])
  @@map("csv_import_row_log")
}

enum CsvImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  PARTIAL
  FAILED
}

enum CsvImportRowStatus {
  VALID
  DUPLICATE_IN_CSV
  DUPLICATE_IN_CENTER
  ERROR
  IMPORTED
  SKIPPED
  FAILED
}

// ─── Exercise Builder (Epic 3) ──────────────────────────────────────

enum ExerciseSkill {
  READING
  LISTENING
  WRITING
  SPEAKING
}

enum ExerciseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum IeltsQuestionType {
  // Reading
  R1_MCQ_SINGLE
  R2_MCQ_MULTI
  R3_TFNG
  R4_YNNG
  R5_SENTENCE_COMPLETION
  R6_SHORT_ANSWER
  R7_SUMMARY_WORD_BANK
  R8_SUMMARY_PASSAGE
  R9_MATCHING_HEADINGS
  R10_MATCHING_INFORMATION
  R11_MATCHING_FEATURES
  R12_MATCHING_SENTENCE_ENDINGS
  R13_NOTE_TABLE_FLOWCHART
  R14_DIAGRAM_LABELLING
  // Listening
  L1_FORM_NOTE_TABLE
  L2_MCQ
  L3_MATCHING
  L4_MAP_PLAN_LABELLING
  L5_SENTENCE_COMPLETION
  L6_SHORT_ANSWER
  // Writing
  W1_TASK1_ACADEMIC
  W2_TASK1_GENERAL
  W3_TASK2_ESSAY
  // Speaking
  S1_PART1_QA
  S2_PART2_CUE_CARD
  S3_PART3_DISCUSSION
}

model Exercise {
  id             String         @id @default(cuid())
  centerId       String         @map("center_id")
  title          String
  instructions   String?
  skill          ExerciseSkill
  status         ExerciseStatus @default(DRAFT)
  passageContent    String?        @map("passage_content") @db.Text
  passageFormat     String?        @map("passage_format")
  passageSourceType String?        @map("passage_source_type")
  passageSourceUrl  String?        @map("passage_source_url")
  caseSensitive             Boolean        @default(false) @map("case_sensitive")
  partialCredit             Boolean        @default(false) @map("partial_credit")
  audioUrl                  String?        @map("audio_url")
  audioDuration             Int?           @map("audio_duration")
  playbackMode              String?        @map("playback_mode")
  audioSections             Json?          @map("audio_sections")
  showTranscriptAfterSubmit Boolean        @default(false) @map("show_transcript_after_submit")
  stimulusImageUrl          String?        @map("stimulus_image_url")
  writingPrompt             String?        @map("writing_prompt") @db.Text
  letterTone                String?        @map("letter_tone")
  wordCountMin              Int?           @map("word_count_min")
  wordCountMax              Int?           @map("word_count_max")
  wordCountMode             String?        @map("word_count_mode")
  sampleResponse            String?        @map("sample_response") @db.Text
  showSampleAfterGrading    Boolean        @default(false) @map("show_sample_after_grading")
  speakingPrepTime          Int?           @map("speaking_prep_time")
  speakingTime              Int?           @map("speaking_time")
  maxRecordingDuration      Int?           @map("max_recording_duration")
  enableTranscription       Boolean        @default(false) @map("enable_transcription")
  timeLimit                 Int?           @map("time_limit")
  timerPosition             String?        @map("timer_position")
  warningAlerts             Json?          @map("warning_alerts")
  autoSubmitOnExpiry        Boolean        @default(true) @map("auto_submit_on_expiry")
  gracePeriodSeconds        Int?           @map("grace_period_seconds")
  enablePause               Boolean        @default(false) @map("enable_pause")
  bandLevel                 String?        @map("band_level")
  createdById               String         @map("created_by_id")
  createdAt                 DateTime       @default(now()) @map("created_at")
  updatedAt                 DateTime       @updatedAt @map("updated_at")

  createdBy         User                    @relation("ExerciseCreator", fields: [createdById], references: [id])
  sections          QuestionSection[]
  tagAssignments             ExerciseTagAssignment[]
  aiGenerationJobs           AIGenerationJob[]
  mockTestSectionExercises   MockTestSectionExercise[]
  assignments                Assignment[]

  @@unique([id, centerId])
  @@index([centerId])
  @@index([centerId, skill])
  @@index([centerId, status])
  @@index([centerId, bandLevel])
  @@map("exercise")
}

model ExerciseTag {
  id        String   @id @default(cuid())
  centerId  String   @map("center_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tagAssignments ExerciseTagAssignment[]

  @@unique([centerId, name])
  @@index([centerId])
  @@map("exercise_tag")
}

model ExerciseTagAssignment {
  id         String   @id @default(cuid())
  exerciseId String   @map("exercise_id")
  tagId      String   @map("tag_id")
  centerId   String   @map("center_id")
  createdAt  DateTime @default(now()) @map("created_at")

  exercise Exercise    @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  tag      ExerciseTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([exerciseId, tagId])
  @@index([exerciseId])
  @@index([tagId])
  @@index([centerId])
  @@map("exercise_tag_assignment")
}

model QuestionSection {
  id           String            @id @default(cuid())
  exerciseId   String            @map("exercise_id")
  centerId     String            @map("center_id")
  sectionType       IeltsQuestionType @map("section_type")
  instructions      String?
  orderIndex        Int               @map("order_index")
  audioSectionIndex Int?              @map("audio_section_index")
  sectionTimeLimit  Int?              @map("section_time_limit")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  exercise  Exercise   @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  questions Question[]

  @@unique([id, centerId])
  @@index([centerId])
  @@index([exerciseId])
  @@map("question_section")
}

model Question {
  id            String   @id @default(cuid())
  sectionId     String   @map("section_id")
  centerId      String   @map("center_id")
  questionText  String   @map("question_text")
  questionType  String   @map("question_type")
  options       Json?
  correctAnswer Json?    @map("correct_answer")
  orderIndex    Int      @map("order_index")
  wordLimit     Int?     @map("word_limit")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  section        QuestionSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  studentAnswers StudentAnswer[]

  @@unique([id, centerId])
  @@index([centerId])
  @@index([sectionId])
  @@map("question")
}

model AIGenerationJob {
  id            String   @id @default(cuid())
  centerId      String   @map("center_id")
  exerciseId    String   @map("exercise_id")
  status        String   @default("pending")
  questionTypes Json     @map("question_types")
  difficulty    String?
  error         String?
  result        Json?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([centerId])
  @@index([exerciseId])
  @@map("ai_generation_job")
}

// ─── Mock Test Assembly (Story 3.13) ────────────────────────────────

model MockTest {
  id          String   @id @default(cuid())
  centerId    String   @map("center_id")
  title       String
  description String?
  testType    String   @default("ACADEMIC") @map("test_type")
  status      String   @default("DRAFT")

  createdById String   @map("created_by_id")
  createdBy   User     @relation("MockTestCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  sections MockTestSection[]

  @@unique([id, centerId])
  @@index([centerId])
  @@index([centerId, status])
  @@map("mock_test")
}

model MockTestSection {
  id         String @id @default(cuid())
  mockTestId String @map("mock_test_id")
  centerId   String @map("center_id")
  skill      String
  orderIndex Int    @map("order_index")
  timeLimit  Int?   @map("time_limit")

  mockTest  MockTest                  @relation(fields: [mockTestId], references: [id], onDelete: Cascade)
  exercises MockTestSectionExercise[]

  @@unique([id, centerId])
  @@index([centerId])
  @@index([mockTestId])
  @@map("mock_test_section")
}

model MockTestSectionExercise {
  id         String @id @default(cuid())
  sectionId  String @map("section_id")
  centerId   String @map("center_id")
  exerciseId String @map("exercise_id")
  orderIndex Int    @map("order_index")

  section  MockTestSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  exercise Exercise        @relation(fields: [exerciseId], references: [id])

  @@unique([id, centerId])
  @@unique([sectionId, exerciseId])
  @@index([centerId])
  @@index([sectionId])
  @@map("mock_test_section_exercise")
}

// ─── Exercise Assignment Management (Story 3.15) ────────────────────

enum AssignmentStatus {
  OPEN
  CLOSED
  ARCHIVED
}

model Assignment {
  id           String           @id @default(cuid())
  centerId     String           @map("center_id")
  exerciseId   String           @map("exercise_id")
  classId      String?          @map("class_id")
  dueDate      DateTime?        @map("due_date")
  timeLimit    Int?             @map("time_limit")
  instructions String?
  status       AssignmentStatus @default(OPEN)
  createdById  String           @map("created_by_id")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  exercise           Exercise            @relation(fields: [exerciseId], references: [id])
  class              Class?              @relation(fields: [classId], references: [id])
  createdBy          User                @relation("AssignmentCreator", fields: [createdById], references: [id])
  studentAssignments AssignmentStudent[]
  submissions        Submission[]

  @@unique([id, centerId])
  @@index([centerId])
  @@index([centerId, exerciseId])
  @@index([centerId, classId])
  @@index([centerId, status])
  @@index([centerId, dueDate])
  @@map("assignment")
}

model AssignmentStudent {
  id           String   @id @default(cuid())
  assignmentId String   @map("assignment_id")
  studentId    String   @map("student_id")
  centerId     String   @map("center_id")
  createdAt    DateTime @default(now()) @map("created_at")

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    User       @relation("AssignmentStudents", fields: [studentId], references: [id])

  @@unique([assignmentId, studentId])
  @@index([centerId])
  @@index([studentId, centerId])
  @@map("assignment_student")
}

// ─── Student Submissions (Epic 4) ───────────────────────────────────

enum SubmissionStatus {
  IN_PROGRESS
  SUBMITTED
  AI_PROCESSING
  GRADED
}

model Submission {
  id           String           @id @default(cuid())
  centerId     String           @map("center_id")
  assignmentId String           @map("assignment_id")
  studentId    String           @map("student_id")
  status       SubmissionStatus @default(IN_PROGRESS)
  startedAt    DateTime         @default(now()) @map("started_at")
  submittedAt  DateTime?        @map("submitted_at")
  timeSpentSec Int?             @map("time_spent_sec")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  assignment Assignment      @relation(fields: [assignmentId], references: [id])
  student    User            @relation(fields: [studentId], references: [id])
  answers    StudentAnswer[]
  gradingJob       GradingJob?
  feedback         SubmissionFeedback?
  teacherComments  TeacherComment[]

  @@unique([id, centerId])
  @@unique([assignmentId, studentId])
  @@index([centerId])
  @@index([centerId, studentId])
  @@index([centerId, assignmentId])
  @@map("submission")
}

model StudentAnswer {
  id           String   @id @default(cuid())
  submissionId String   @map("submission_id")
  questionId   String   @map("question_id")
  centerId     String   @map("center_id")
  answer       Json?    @map("answer")
  photoUrl     String?  @map("photo_url")
  isCorrect    Boolean? @map("is_correct")
  score        Float?   @map("score")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  question   Question   @relation(fields: [questionId], references: [id])

  @@unique([id, centerId])
  @@unique([submissionId, questionId])
  @@index([centerId])
  @@index([centerId, submissionId])
  @@map("student_answer")
}

// ─── AI Grading (Story 5.1) ────────────────────────────────────────

model GradingJob {
  id            String   @id @default(cuid())
  centerId      String   @map("center_id")
  submissionId  String   @unique @map("submission_id")
  status        String   @default("pending") // pending | processing | completed | failed
  error         String?
  errorCategory String?  @map("error_category") // "api_timeout" | "rate_limit" | "invalid_response" | "validation_error" | "other"
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([centerId])
  @@index([submissionId])
  @@map("grading_job")
}

model SubmissionFeedback {
  id                      String   @id @default(cuid())
  centerId                String   @map("center_id")
  submissionId            String   @unique @map("submission_id")
  overallScore            Float?   @map("overall_score")
  criteriaScores          Json?    @map("criteria_scores")
  generalFeedback         String?  @map("general_feedback")
  teacherFinalScore       Float?   @map("teacher_final_score")
  teacherCriteriaScores   Json?    @map("teacher_criteria_scores")
  teacherGeneralFeedback  String?  @map("teacher_general_feedback")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  submission Submission       @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  items      AIFeedbackItem[]

  @@index([centerId])
  @@map("submission_feedback")
}

model AIFeedbackItem {
  id                     String    @id @default(cuid())
  centerId               String    @map("center_id")
  submissionFeedbackId   String    @map("submission_feedback_id")
  questionId             String?   @map("question_id")
  type                   String    // "grammar" | "vocabulary" | "coherence" | "score_suggestion" | "general"
  content                String
  startOffset            Int?      @map("start_offset")
  endOffset              Int?      @map("end_offset")
  originalContextSnippet String?   @map("original_context_snippet")
  suggestedFix           String?   @map("suggested_fix")
  severity               String?   // "error" | "warning" | "suggestion"
  confidence             Float?
  isApproved             Boolean?  @map("is_approved")
  approvedAt             DateTime? @map("approved_at")
  teacherOverrideText    String?   @map("teacher_override_text")
  createdAt              DateTime  @default(now()) @map("created_at")

  submissionFeedback SubmissionFeedback @relation(fields: [submissionFeedbackId], references: [id], onDelete: Cascade)

  @@index([centerId])
  @@index([submissionFeedbackId])
  @@map("ai_feedback_item")
}

// ─── Teacher Comments (Story 5.7) ───────────────────────────────────

model TeacherComment {
  id                     String    @id @default(cuid())
  centerId               String    @map("center_id")
  submissionId           String    @map("submission_id")
  authorId               String    @map("author_id")
  content                String
  startOffset            Int?      @map("start_offset")
  endOffset              Int?      @map("end_offset")
  originalContextSnippet String?   @map("original_context_snippet")
  visibility             String    @default("student_facing") // "private" | "student_facing"
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  author     User       @relation(fields: [authorId], references: [id])

  @@index([centerId])
  @@index([submissionId])
  @@map("teacher_comment")
}

// ─── Email Logging ──────────────────────────────────────────────────

model EmailLog {
  id          String   @id @default(cuid())
  recipientId String   @map("recipient_id")
  centerId    String   @map("center_id")
  type        String   // "schedule-change" | "session-cancelled"
  status      String   // "sent" | "failed" | "skipped"
  subject     String?
  error       String?
  sentAt      DateTime @default(now()) @map("sent_at")

  recipient User @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([centerId])
  @@index([recipientId])
  @@index([type, sentAt])
  @@map("email_log")
}
