# Story 3.5.5: Epic 3 E2E Tests

Status: ready-for-dev

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a QA Engineer,
I want Playwright E2E tests covering the core exercise builder and assignment flows from Epic 3,
so that we have confidence these features work end-to-end and can catch regressions.

## Acceptance Criteria

1. **AC1: Exercise Builder Flow** — E2E test covering: navigate to exercises page → create new exercise → set skill type (Reading) → add a passage → add a question section (MCQ) → add questions with answer options → mark correct answers → save exercise → verify exercise appears in exercise list.
2. **AC2: Question Type Coverage** — E2E tests for at least one question type per skill: Reading (MCQ — R1), Listening (gap fill — L3, with audio upload stubbed/mocked), Writing (Task 2 essay — W2), Speaking (Part 1 — S1). Each test creates an exercise with that question type and verifies it saves correctly.
3. **AC3: Exercise Library Flow** — E2E test covering: navigate to exercise library → verify exercises are listed → use skill filter → use search → duplicate an exercise → verify duplicate appears → archive an exercise → verify it moves to archived.
4. **AC4: Assignment Flow** — E2E test covering: navigate to assignments → create new assignment → select an exercise → select target class(es) → set due date → publish assignment → verify assignment appears in list → verify student can see assignment in student dashboard.
5. **AC5: Mock Test Flow** — E2E test covering: navigate to mock tests → create mock test → add exercises for each skill section → configure band score settings → save → verify mock test appears in list.
6. **AC6: Tag Management Flow** — E2E test covering: navigate to settings → tags page → create a new topic tag → assign tag to an exercise → filter exercises by tag → verify filtered results.
7. **AC7: Staging CI Integration** — E2E tests run against staging environment in CI. Tests triggered after staging deployment (in the deploy-staging workflow from Story 3.5.1). Test results reported in CI (HTML report on failure). Tests must pass for staging to be considered healthy.
8. **AC8: Test Data Isolation** — Each E2E test creates its own test data (exercises, assignments) and cleans up after itself, or uses unique identifiers to avoid collision with other tests or seed data.

## Scope Clarification

**What IS built in this story:**
- Playwright E2E test files in `apps/e2e/tests/exercises/` directory
- E2E tests for exercise creation, library management, assignments, mock tests, tags
- CI integration to run E2E tests against staging
- Test fixtures and helpers for exercise-related flows

**What is NOT built (out of scope):**
- E2E tests for student submission (Epic 4)
- E2E tests for grading (Epic 5)
- Performance or load testing
- Visual regression testing
- Mobile-specific E2E tests (Playwright mobile Chrome is configured but exercise builder is desktop-focused)

## Tasks / Subtasks

### Task 1: Test Fixtures & Helpers (AC: 8)

- [ ] 1.1 Create `apps/e2e/fixtures/exercise-fixtures.ts`:
  - Helper to create a test exercise via UI (navigate, fill form, save)
  - Helper to create a test exercise via API (faster setup for tests that don't test creation)
  - Helper to clean up test exercises after test
- [ ] 1.2 Create `apps/e2e/fixtures/assignment-fixtures.ts`:
  - Helper to create a test assignment via UI
  - Helper to clean up test assignments
- [ ] 1.3 Extend existing test utils with exercise-specific page objects or helper functions
- [ ] 1.4 Ensure test data uses unique names (e.g., timestamp-suffixed) to avoid collisions

### Task 2: Exercise Builder E2E Tests (AC: 1, 2)

- [ ] 2.1 Create `apps/e2e/tests/exercises/create-exercise.spec.ts`:
  - Test: Create Reading exercise with MCQ questions (R1)
  - Navigate to exercises → click "Create" → select Reading skill
  - Add passage content
  - Add MCQ question section → add questions with options → mark correct answers
  - Save → verify redirect to exercise list → verify exercise appears
- [ ] 2.2 Create `apps/e2e/tests/exercises/question-types.spec.ts`:
  - Test: Create Listening exercise (stub/mock audio upload, test L3 gap fill questions)
  - Test: Create Writing exercise (W2 essay task with rubric)
  - Test: Create Speaking exercise (S1 Part 1 with prompt)
- [ ] 2.3 Create `apps/e2e/tests/exercises/exercise-editor.spec.ts`:
  - Test: Edit an existing exercise → modify questions → save → verify changes persist
  - Test: Add timer settings → save → verify timer appears on exercise
  - Test: Add band level and topic tags → save → verify tags persist

### Task 3: Exercise Library E2E Tests (AC: 3)

- [ ] 3.1 Create `apps/e2e/tests/exercises/exercise-library.spec.ts`:
  - Test: Exercise list displays created exercises
  - Test: Filter by skill (Reading, Listening, Writing, Speaking)
  - Test: Search exercises by title
  - Test: Duplicate exercise → verify copy appears with "(Copy)" suffix
  - Test: Archive exercise → verify it moves to archived view
  - Test: Restore archived exercise

### Task 4: Assignment Flow E2E Tests (AC: 4)

- [ ] 4.1 Create `apps/e2e/tests/exercises/assignments.spec.ts`:
  - Test: Create assignment → select exercise → select class → set due date → publish
  - Test: Verify assignment appears in assignment list
  - Test: Switch to student role → verify assignment visible in student dashboard
  - Test: Verify assignment card shows exercise title, skill icon, due date
- [ ] 4.2 Test assignment status changes (open/closed)

### Task 5: Mock Test E2E Tests (AC: 5)

- [ ] 5.1 Create `apps/e2e/tests/exercises/mock-tests.spec.ts`:
  - Test: Create mock test → add exercises for Reading, Listening, Writing, Speaking sections
  - Test: Configure band score calculation settings
  - Test: Save → verify mock test appears in list
  - Test: View mock test details → verify sections and exercises displayed

### Task 6: Tag Management E2E Tests (AC: 6)

- [ ] 6.1 Create `apps/e2e/tests/exercises/tags.spec.ts`:
  - Test: Navigate to settings → tags → create new topic tag
  - Test: Assign tag to exercise via exercise editor
  - Test: Filter exercise library by tag → verify filtered results
  - Test: Rename tag → verify updated across exercises
  - Test: Delete tag → verify removed from exercises

### Task 7: Staging CI Integration (AC: 7)

- [ ] 7.1 Update `.github/workflows/deploy-staging.yml` to add E2E test step after deployment:
  - Wait for staging deployment to be healthy (hit health check endpoint)
  - Run `pnpm test:e2e` with `E2E_BASE_URL` pointing to staging URL
  - Upload Playwright report artifact on failure
- [ ] 7.2 Configure `playwright.config.ts` to accept `E2E_BASE_URL` env var (already supported — verify)
- [ ] 7.3 Test: staging deploy triggers E2E tests → tests pass → report available
- [ ] 7.4 Document: "E2E tests run automatically after staging deployment"

## Dev Notes

- Existing E2E test structure in `apps/e2e/tests/` has directories per feature: `auth/`, `logistics/`, `navigation/`, `users/`. Add `exercises/` directory following the same pattern.
- Existing Playwright config supports Chromium, Firefox, and Mobile Chrome. Focus on Chromium for exercise builder tests (desktop-first feature).
- `apps/e2e/fixtures/` directory exists — extend with exercise-specific fixtures.
- `apps/e2e/utils/` directory exists — leverage existing utility functions.
- Audio upload for listening exercises may need mocking or a small test audio file in fixtures.
- The `scripts/run-e2e.sh` script orchestrates local E2E runs — can be used for local development. CI runs against staging directly.
- This story establishes the **E2E-per-epic gate** agreed upon in the Epic 3 retrospective. Going forward, each epic must have a corresponding E2E test story completed before the epic is marked done.

## Dependencies

- **Depends on:** Story 3.5.1 (staging environment must be deployed and accessible)
- **Blocks:** None
- **Can run in parallel with:** Story 3.5.4 (Error Boundaries & Accessibility)
