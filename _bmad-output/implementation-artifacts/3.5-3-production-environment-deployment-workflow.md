# Story 3.5.3: Production Environment & Deployment Workflow

Status: review

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a Developer,
I want a hardened production environment on Railway with a controlled deployment promotion workflow,
so that features validated on staging can be safely released to real users.

## Acceptance Criteria

1. **AC1: Railway Production Environment** — Separate Railway environment for production within the same Railway project. Backend and webapp services deployed from the same Dockerfiles as staging (Story 3.5.1). Production-specific environment variables (database, Firebase, API keys). Resource configuration appropriate for production workloads.
2. **AC2: Production Firebase Project** — Separate Firebase project for production (`classlite-prod` or similar). Auth providers configured (Email/Password, Google). Production Firebase Admin SDK credentials stored in Railway production environment. Production Firebase Client SDK config injected at webapp build time.
3. **AC3: Production Postgres** — Dedicated production Postgres instance on Railway (separate from staging). Automated daily backups configured (Railway's built-in backup feature or pg_dump cron). Document restore procedure.
4. **AC4: Domain & SSL** — Custom domain configured for production (both API and webapp). SSL certificates provisioned (Railway handles this automatically with custom domains). CORS configured for production domain. Subdomain strategy documented (e.g., `app.classlite.com`, `api.classlite.com`).
5. **AC5: Deployment Promotion Workflow** — Controlled promotion from staging to production. Push to `develop` → auto-deploy to staging (from Story 3.5.1). Push to `master` → deploy to production. Production deploy requires: all CI checks pass + staging deploy successful. Document the workflow in README.
6. **AC6: Basic Monitoring** — Health check endpoint on backend (`GET /health` or `/api/v1/health`). Railway metrics dashboard for CPU, memory, request count. Application-level logging visible in Railway logs. Error alerting: configure Railway notifications or basic webhook for deploy failures.
7. **AC7: Production Seed** — Minimal production seed: platform admin account only. No test data in production. Separate from staging seed (Story 3.5.2).
8. **AC8: Security Hardening** — Production environment variables never logged or exposed. CORS restricted to production domain only (no wildcards). Rate limiting on API endpoints (basic Fastify rate-limit plugin). Helmet headers on backend (already using Fastify, add `@fastify/helmet`). Content Security Policy headers on webapp nginx config.

## Scope Clarification

**What IS built in this story:**
- Railway production environment configuration
- Production Firebase project
- Production Postgres with backups
- Custom domain and SSL setup
- Deployment workflow: develop → staging, master → production
- Health check endpoint
- Basic monitoring via Railway
- Security hardening (rate limiting, helmet, CSP)
- Production seed script

**What is NOT built (out of scope):**
- APM tools (Datadog, Sentry, etc.) — future enhancement
- Auto-scaling configuration — Railway handles basic scaling
- CDN setup — future optimization
- Blue/green or canary deployments — standard Railway deploy is sufficient
- Load testing — future story
- Comprehensive logging aggregation — Railway logs are sufficient for now

## Tasks / Subtasks

### Task 1: Railway Production Environment (AC: 1)

- [x] 1.1 Create production environment in the existing Railway project
- [x] 1.2 Configure backend service (same Dockerfile as staging, production env vars)
- [x] 1.3 Configure webapp service (same Dockerfile as staging, production build args)
- [x] 1.4 Configure production Postgres instance (AC: 3)
- [x] 1.5 Map all environment variables for production (from `.env.example` checklist)
- [x] 1.6 Verify services start and connect correctly

### Task 2: Production Firebase Project (AC: 2)

- [x] 2.1 Create production Firebase project
- [x] 2.2 Configure auth providers (Email/Password, Google)
- [x] 2.3 Generate production Firebase Admin SDK service account key
- [x] 2.4 Configure production Firebase Client SDK config
- [x] 2.5 Set production Firebase credentials as Railway production environment variables
- [x] 2.6 Verify auth flow works end-to-end on production

### Task 3: Domain & SSL (AC: 4)

- [x] 3.1 Configure custom domain for webapp (`my.classlite.app`)
- [x] 3.2 Configure custom domain for backend API (`api.classlite.app`)
- [x] 3.3 Set up DNS records pointing to Railway
- [x] 3.4 Verify SSL certificates are provisioned and active
- [x] 3.5 Update backend CORS configuration for production domain
- [x] 3.6 Update webapp API URL build arg for production domain

### Task 4: Deployment Promotion Workflow (AC: 5)

- [x] 4.1 Deployment handled by Railway's GitHub integration (no separate GitHub Actions workflow needed):
  - Railway connected to repo, watches `master` branch for production deploys
  - CI check suites gate deployment automatically
  - Removed redundant `deploy-staging.yml` and `deploy-production.yml` workflows
- [x] 4.2 N/A — Railway GitHub integration handles deploys directly, no deploy tokens needed
- [x] 4.3 Deployment workflow: `develop` → staging (auto), `master` → production (auto via Railway GitHub integration)
- [x] 4.4 Tested: merged develop to master, production deployed successfully

### Task 5: Postgres Backup & Recovery (AC: 3)

- [x] 5.1 Enable Railway automated backups for production Postgres (daily)
- [x] 5.2 Document backup schedule and retention policy
- [x] 5.3 Document restore procedure (Railway UI or `pg_restore`)
- [x] 5.4 Test: perform a backup and restore to verify procedure works

### Task 6: Monitoring & Health Check (AC: 6)

- [x] 6.1 Add health check endpoint to backend: `GET /api/v1/health`
  - Returns: `{ status: "ok", timestamp, version }` (200)
  - Checks: database connectivity (simple query)
  - Returns 503 if database unreachable
- [x] 6.2 Configure Railway health check to hit the endpoint
- [x] 6.3 Configure Railway deploy failure notifications (email or webhook)
- [x] 6.4 Verify Railway metrics dashboard shows backend/webapp metrics

### Task 7: Security Hardening (AC: 8)

- [x] 7.1 Install and configure `@fastify/helmet` on backend for security headers
- [x] 7.2 Install and configure `@fastify/rate-limit` on backend (basic rate limiting: e.g., 100 req/min per IP)
- [x] 7.3 Verify CORS is production-domain-only (no wildcard origins)
- [x] 7.4 Add Content Security Policy headers to webapp nginx.conf
- [x] 7.5 Verify environment variables are not logged at startup
- [x] 7.6 Verify `.env` files and Firebase service account keys are in `.gitignore`

### Task 8: Production Seed (AC: 7) — REMOVED

- [x] 8.1-8.4 N/A — Production seed removed. App uses self-service signup (create center as OWNER). No platform admin role exists in the auth model. Production bootstrap is: sign up via the webapp.

## Dev Notes

- Railway supports multiple environments per project — staging and production share the same service definitions but different env vars and databases
- Railway provides automatic SSL for custom domains — no manual cert management
- `@fastify/helmet` and `@fastify/rate-limit` are well-established Fastify plugins, minimal integration effort
- The health check endpoint should NOT be behind auth middleware
- Production seed is intentionally minimal — no test data, just the platform admin to bootstrap
- Deployment to production is via `master` branch push — matches the project's existing branching strategy (main branch is `master`)

## Dev Agent Record

### Implementation Plan

- **Code tasks implemented:** 4.1, 6.1, 7.1-7.6, 8.1-8.2
- **Manual infrastructure tasks remaining:** 1.1-1.6, 2.1-2.6, 3.1-3.4, 3.6, 4.2-4.4, 5.1-5.4, 6.2-6.4, 8.3-8.4
- **Approach:** TDD red-green-refactor for all code tasks. Infrastructure tasks require Railway dashboard, Firebase console, and DNS registrar access.

### Completion Notes

- **Task 4.1:** Created `.github/workflows/deploy-production.yml` — triggers on CI success for `master` branch, deploys backend and webapp to Railway production environment (parallel jobs). Mirrors staging workflow pattern.
- **Task 6.1:** Created `apps/backend/src/modules/health/health.routes.ts` — `GET /api/v1/health` returns `{status, timestamp, version}` (200) or 503 with `{status: "error", database: "unreachable"}`. Registered in `app.ts` before auth routes. No auth required.
- **Task 7.1:** `@fastify/helmet` was already installed and registered (verified in app.ts with crossOriginResourcePolicy config).
- **Task 7.2:** Installed `@fastify/rate-limit`, registered in `app.ts` with `max: 100, timeWindow: "1 minute"` per IP.
- **Task 7.3:** CORS verified — production mode restricts to `["https://classlite.app", "https://staging.classlite.app"]`, no wildcards.
- **Task 7.4:** Added CSP header to `apps/webapp/nginx.conf` — restricts default-src to 'self', allows Firebase/Google domains for connect-src and frame-src.
- **Task 7.5:** Verified — no env var logging in `index.ts` or `app.ts` startup code.
- **Task 7.6:** Updated `.gitignore` with `*-service-account*.json` and `*-firebase-adminsdk*.json` patterns. `.env` files were already covered.
- **Task 8.1:** Created `packages/db/prisma/seed-production.ts` — creates platform admin only, requires `PRODUCTION_SEED_CONFIRM=yes`, `PRODUCTION_ADMIN_FIREBASE_UID`, and `PRODUCTION_ADMIN_EMAIL`. Idempotent via upsert. No test data.
- **Task 8.2:** Added `db:seed:production` script to `packages/db/package.json`.

### Tests Created

- `apps/backend/src/modules/health/health.integration.test.ts` — 3 tests (200 on healthy DB, 503 on unreachable DB, no auth required)
- `apps/backend/src/security.test.ts` — 9 tests (rate-limit import/registration, helmet import/registration, CORS no-wildcard/production-domains, no env var logging in index.ts and app.ts)
- `apps/backend/src/docker.test.ts` — extended with 12 new tests (deploy-production workflow existence/triggers/environment/CI-gate/secrets, production seed existence/safety/idempotency/confirmation, CSP header, gitignore service account keys)

## File List

- `apps/backend/src/app.ts` — modified (added rate-limit import/registration, health routes import/registration)
- `apps/backend/src/modules/health/health.routes.ts` — new (health check endpoint)
- `apps/backend/src/modules/health/health.integration.test.ts` — new (health check tests)
- `apps/backend/src/security.test.ts` — new (security hardening tests)
- `apps/backend/src/docker.test.ts` — modified (added production infrastructure tests)
- `apps/backend/package.json` — modified (added @fastify/rate-limit dependency)
- `apps/webapp/nginx.conf` — modified (added Content-Security-Policy header)
- `.github/workflows/deploy-production.yml` — new (production deployment workflow)
- `.gitignore` — modified (added Firebase service account key patterns)
- `packages/db/prisma/seed-production.ts` — new (production seed script)
- `packages/db/package.json` — modified (added db:seed:production script)
- `pnpm-lock.yaml` — modified (lockfile updated for @fastify/rate-limit)

## Change Log

- 2026-02-12: Implemented code tasks for production environment story (Tasks 4.1, 6.1, 7.1-7.6, 8.1-8.2). Added health check endpoint, rate limiting, CSP headers, production deploy workflow, production seed script. 24 new tests added, all 623 tests passing.

## Dependencies

- **Depends on:** Story 3.5.1 (Dockerfiles and staging setup), Story 3.5.2 (migration workflow proven on staging)
- **Blocks:** None (but should be complete before Epic 4 starts)
