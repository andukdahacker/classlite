# Story 3.5.2: Database Migration Strategy

Status: ready-for-dev

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a Developer,
I want a reliable database migration workflow using Prisma Migrate,
so that schema changes are versioned, reviewable, and safely deployable to staging and production.

## Acceptance Criteria

1. **AC1: Baseline Migration** — Create an initial baseline migration from the current Prisma schema. This captures the full schema as-is (all models from Epics 1-3) as the starting point for versioned migrations. Use `prisma migrate diff` or `prisma migrate dev --create-only` to generate the baseline.
2. **AC2: Migration Workflow** — Document and enforce the migration workflow: Developer modifies `schema.prisma` → runs `prisma migrate dev --name <description>` → migration SQL file generated in `packages/db/prisma/migrations/` → migration file committed with code changes → reviewed in PR. No more `db push` for schema changes.
3. **AC3: CI Migration Validation** — Add a CI check that verifies migrations are in sync with the schema. Run `prisma migrate diff` to detect drift between schema and migrations. Fail CI if schema changes exist without corresponding migration files.
4. **AC4: Staging Deploy Integration** — Migrations auto-apply on staging deployment via the existing `prisma migrate deploy` prestart hook. Verify migrations run successfully on Railway staging Postgres. Verify rollback path: document how to revert a bad migration (create a new corrective migration — Prisma doesn't support down migrations natively).
5. **AC5: Seed Data for Staging** — Create or adapt a seed script for staging environment. Seed should create: at least one test center, test users (owner, admin, teacher, student), sample exercises across skill types. Seed script idempotent (safe to run multiple times). Separate from production seed (if any).
6. **AC6: Legacy @@map Cleanup** — Audit all Prisma models for `@@map` compliance. Any models missing `@@map("snake_case")` get it added. Generate migration for the table renames. This resolves Epic 2 retro action item A2 (Prisma naming unification).

## Scope Clarification

**What IS built in this story:**
- Baseline migration file capturing current schema state
- Migration workflow documentation
- CI check for migration-schema sync
- Staging seed script
- @@map cleanup migration
- Updated `packages/db/package.json` scripts if needed

**What is NOT built (out of scope):**
- Production database setup (Story 3.5.3)
- Data migration from development DB to staging (manual or separate task)
- Backup and restore procedures (Story 3.5.3)
- Schema changes for Epic 4 features

## Tasks / Subtasks

### Task 1: Legacy @@map Audit & Cleanup (AC: 6)

- [ ] 1.1 Audit all models in `packages/db/prisma/schema.prisma` — list any missing `@@map("snake_case")` directives
- [ ] 1.2 Add `@@map` to all models that are missing it (maintain existing field-level `@map` directives)
- [ ] 1.3 Verify no application code references table names directly (Prisma Client uses model names, not table names — should be safe)
- [ ] 1.4 Note: This rename will be captured in the baseline migration or as a separate migration

### Task 2: Baseline Migration (AC: 1)

- [ ] 2.1 Ensure `packages/db/prisma/migrations/` directory exists
- [ ] 2.2 Generate baseline migration using `prisma migrate diff --from-empty --to-schema-datafile prisma/schema.prisma --script > prisma/migrations/<timestamp>_baseline/migration.sql`
- [ ] 2.3 Mark baseline as applied on development database: `prisma migrate resolve --applied <migration_name>`
- [ ] 2.4 Verify baseline migration creates all tables, indexes, constraints from current schema
- [ ] 2.5 Test: fresh database + `prisma migrate deploy` produces identical schema to current `db push` result

### Task 3: Migration Workflow Setup (AC: 2)

- [ ] 3.1 Update `packages/db/package.json` scripts:
  - `db:migrate:dev` → `prisma migrate dev` (for local development)
  - `db:migrate:deploy` → `prisma migrate deploy` (for staging/production)
  - `db:migrate:create` → `prisma migrate dev --create-only` (create migration without applying)
  - `db:migrate:status` → `prisma migrate status` (check migration state)
- [ ] 3.2 Update `project-context.md` development workflow section to reflect new migration workflow (replace `db push` references)
- [ ] 3.3 Remove or deprecate `db:push` script (or add warning comment that it's for prototyping only)

### Task 4: CI Migration Validation (AC: 3)

- [ ] 4.1 Add migration check step to `.github/workflows/ci.yml` (or deploy workflow):
  - Run `prisma migrate diff --from-migrations ./prisma/migrations --to-schema-datafile ./prisma/schema.prisma --exit-code`
  - If exit code != 0, schema has drifted from migrations → fail CI
- [ ] 4.2 Ensure this check runs before tests (catches missing migrations early)
- [ ] 4.3 Test: modify schema without creating migration → verify CI fails

### Task 5: Staging Seed Script (AC: 5)

- [ ] 5.1 Create `packages/db/prisma/seed-staging.ts`:
  - Create test center ("ClassLite Demo Center")
  - Create test users with Firebase auth accounts: owner, admin, teacher, student
  - Create sample exercises: 1 Reading, 1 Listening, 1 Writing, 1 Speaking (with question sections and questions)
  - Create sample tags, assignments
- [ ] 5.2 Make seed idempotent (use `upsert` or check-before-create pattern)
- [ ] 5.3 Add `db:seed:staging` script to `packages/db/package.json`
- [ ] 5.4 Document how to run seed against staging database

### Task 6: Staging Deploy Verification (AC: 4)

- [ ] 6.1 Deploy to staging (via Story 3.5.1 pipeline) with migrations enabled
- [ ] 6.2 Verify `prisma migrate deploy` runs on container start and applies baseline migration
- [ ] 6.3 Run staging seed script against staging database
- [ ] 6.4 Verify application functions correctly on staging with migrated + seeded database
- [ ] 6.5 Document rollback procedure: "To revert migration X, create a new migration that undoes the changes. Prisma Migrate does not support automatic rollbacks."

## Dev Notes

- Current state: project uses `db push` exclusively — no migration files exist yet
- `prisma migrate deploy` is already in the backend `prestart` script — no change needed for deploy-time execution
- The @@map cleanup may rename tables in PostgreSQL. On a fresh staging DB this is a non-issue. On the development DB, `prisma migrate resolve` marks the baseline as already applied.
- Prisma Migrate doesn't support down migrations. Rollbacks require creating a new forward migration. Document this clearly.
- The existing `prisma/seed_user.ts` can be referenced but staging seed should be more comprehensive (exercises, assignments, etc.)

## Dependencies

- **Depends on:** Story 3.5.1 (staging environment must exist to verify deployment)
- **Blocks:** Story 3.5.3 (production needs proven migration workflow)
