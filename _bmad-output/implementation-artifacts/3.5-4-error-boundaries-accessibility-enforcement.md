# Story 3.5.4: Error Boundaries & Accessibility Enforcement

Status: ready-for-dev

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a Developer,
I want React error boundaries on all feature routes and enforced accessibility linting,
so that the application degrades gracefully on errors and meets basic accessibility standards.

## Acceptance Criteria

1. **AC1: Route-Level Error Boundaries** — Every feature route entry point wrapped in an error boundary component. Routes include: Dashboard, Exercises, Assignments, Classes, Attendance, Users, Settings, Student Dashboard. Error boundary catches render errors and displays a user-friendly fallback UI (not a blank screen).
2. **AC2: Error Boundary Fallback UI** — Reusable fallback component showing: "Something went wrong" message, option to retry (re-render the failed component), option to navigate home, error details expandable (for developers, hidden by default). Styled consistently with the app's design system (Shadcn/Tailwind).
3. **AC3: Error Boundary Logging** — Errors caught by boundaries are logged with context: component stack, error message, route path. In production: log to console (Railway logs capture stdout). Future: can be wired to Sentry/error tracking service.
4. **AC4: a11y Linting Audit** — Verify `eslint-plugin-jsx-a11y` rules in `packages/eslint-config/react-internal.js` are set to `error` level (not `warn`). If any rules are warnings, promote to errors. Run full lint across `apps/webapp` and `packages/ui` — capture and categorize violations.
5. **AC5: a11y Violation Fixes** — Fix all a11y linting errors found in AC4. Common expected fixes: missing `alt` attributes on images, missing `aria-label` on icon buttons, form inputs without associated labels, missing heading hierarchy. Prioritize: fix all errors, document any intentional suppressions with `// eslint-disable-next-line` + comment explaining why.
6. **AC6: CI a11y Gate** — a11y lint errors fail CI (already part of `turbo lint` if rules are set to error). Verify: push code with a11y violation → CI lint job fails. This ensures no regressions going forward.

## Scope Clarification

**What IS built in this story:**
- Reusable `ErrorBoundary` component and `ErrorFallback` component
- Error boundaries added to all feature route entry points
- a11y lint rules verified and promoted to error level
- All existing a11y violations fixed
- CI gate verification

**What is NOT built (out of scope):**
- External error tracking integration (Sentry, Datadog) — future enhancement
- Comprehensive a11y testing (axe-core, Lighthouse) — future story
- WCAG compliance audit — this is lint-level enforcement only
- a11y for the Astro website (`apps/website`) — webapp only

## Tasks / Subtasks

### Task 1: Error Boundary Component (AC: 2, 3)

- [ ] 1.1 Create `apps/webapp/src/components/error-boundary.tsx`:
  - React error boundary using class component (React 19 still requires class components for error boundaries) or `react-error-boundary` library if preferred
  - Props: `fallback` (optional custom fallback), `onError` (optional callback)
  - State: `hasError`, `error`, `errorInfo`
- [ ] 1.2 Create `apps/webapp/src/components/error-fallback.tsx`:
  - Displays friendly error message
  - "Try Again" button (calls `resetErrorBoundary` or re-renders)
  - "Go to Dashboard" link
  - Expandable error details (collapsed by default, shows error message + component stack)
  - Styled with Shadcn Card + Button components
- [ ] 1.3 Add error logging in `componentDidCatch`: log error, errorInfo, and `window.location.pathname` to console.error
- [ ] 1.4 Write component tests for error boundary:
  - Test: child throws → fallback renders
  - Test: retry button re-renders child
  - Test: error details expandable
  - Test: navigation link works

### Task 2: Route-Level Error Boundary Integration (AC: 1)

- [ ] 2.1 Identify all feature route entry points in `apps/webapp/src/`:
  - Dashboard routes (Owner, Teacher, Student)
  - Exercise routes (list, create, edit)
  - Assignment routes (list, create)
  - Class/Course routes
  - Attendance routes
  - User management routes
  - Settings routes (tags, profile)
- [ ] 2.2 Wrap each route entry point with `<ErrorBoundary>`:
  - Add at the route component level in the router configuration
  - Or wrap individual page components — whichever matches the existing routing pattern
- [ ] 2.3 Verify: throw an error in a feature component → error boundary catches it, displays fallback, other routes still work
- [ ] 2.4 Verify: error in one route doesn't crash the entire application

### Task 3: a11y Linting Audit (AC: 4)

- [ ] 3.1 Read `packages/eslint-config/react-internal.js` — check jsx-a11y rule levels
- [ ] 3.2 If any jsx-a11y rules are set to `warn`, promote to `error`
- [ ] 3.3 If jsx-a11y plugin is using `recommended` preset, verify it maps to `error` level
- [ ] 3.4 Run `pnpm --filter=webapp lint` and `pnpm --filter=ui lint` — capture all a11y violations
- [ ] 3.5 Categorize violations by type and count

### Task 4: a11y Violation Fixes (AC: 5)

- [ ] 4.1 Fix all `img` elements missing `alt` attributes (or add `alt=""` for decorative images)
- [ ] 4.2 Fix all interactive elements (buttons, links) missing accessible names (`aria-label`, visible text)
- [ ] 4.3 Fix all form inputs missing associated labels (`<label>`, `aria-label`, or `aria-labelledby`)
- [ ] 4.4 Fix heading hierarchy issues (`h1` → `h2` → `h3`, no skipped levels)
- [ ] 4.5 Fix any other violations found in audit
- [ ] 4.6 For intentional suppressions: add `// eslint-disable-next-line jsx-a11y/<rule> -- <reason>` with clear justification
- [ ] 4.7 Run lint again — verify zero a11y errors

### Task 5: CI Gate Verification (AC: 6)

- [ ] 5.1 Push a branch with an intentional a11y violation (e.g., `<img>` without `alt`)
- [ ] 5.2 Verify CI lint job fails
- [ ] 5.3 Remove violation, push again, verify CI passes
- [ ] 5.4 Document: "a11y linting is enforced in CI — violations fail the build"

## Dev Notes

- `eslint-plugin-jsx-a11y` is already installed and configured in `packages/eslint-config/react-internal.js` — this is NOT a new setup, just enforcement verification and violation cleanup
- React 19 does not have a hooks-based error boundary API — class components or the `react-error-boundary` library are still needed
- The `react-error-boundary` library is widely used and provides `ErrorBoundary` component + `useErrorBoundary` hook — consider using it for cleaner integration
- Error boundaries do NOT catch: event handler errors, async errors, server-side errors, errors in the error boundary itself
- This story resolves two carry-forward items from Epic 1 retro: A7 (a11y linting) and A8 (error boundaries)

## Dependencies

- **Depends on:** Story 3.5.1 (staging environment for verification)
- **Blocks:** None
- **Can run in parallel with:** Story 3.5.5 (E2E tests)
