# Epic 2 Retrospective: Logistics & Scheduling

**Date:** 2026-02-06
**Facilitator:** Bob (SM)
**Epic:** Epic 2 — Logistics & Scheduling (6 stories: 2.1–2.6)
**Previous Retro:** Epic 1 Retro (2026-02-03)

---

## Stories Reviewed

| Story | Title | Agent Model | Tests | Review Rounds |
|-------|-------|-------------|-------|---------------|
| 2.1 | Course & Class Management | Gemini 2.0 Flash | Backend tests | 1 (5 HIGH findings) |
| 2.2 | Visual Weekly Scheduler | Claude Opus 4.5 | Backend + frontend | 1 |
| 2.3 | Conflict Detection | Claude Opus 4.5 | 189 backend tests | 2 |
| 2.4 | Attendance Tracking | Claude Opus 4.5 | 24 unit tests | 1 |
| 2.5 | Class Session CRUD | Claude Opus 4.5 | 230 backend tests | 1 |
| 2.6 | Schedule Change Notifications | Claude Opus 4.5 | 241 total tests | 1 |

---

## What Went Well

1. **Test volume scaled impressively** — From 24 tests (2.4) to 241 tests (2.6). The team adopted a strong testing discipline as the epic progressed.
2. **Code review process matured** — Story 2.3 had two rounds of review that caught real issues (RBAC on endpoints, race conditions, stale callbacks). The adversarial review model worked.
3. **Inngest adoption for email** — Story 2.6 introduced Inngest for durable background jobs with `cancelOn` debounce, a solid architectural choice for notification workloads.
4. **Multi-tenancy enforcement** — `getTenantedClient(centerId)` pattern consistently applied across all stories.
5. **Story complexity escalation handled** — Story 2.5 (session CRUD with recurrence, drag-to-create, room CRUD) was the most complex story yet and was delivered cleanly.
6. **Backend architecture consistency** — Route-Controller-Service layering followed across all backend stories.

## What Didn't Go Well

1. **Gemini code quality gap** — Story 2.1 (built with Gemini 2.0 Flash) had 5 HIGH severity review findings vs Claude Opus stories averaging 0-2. Foundational stories 1-1, 1-2, 1-3 were also Gemini-built with CRITICAL findings.
2. **Frontend component tests consistently deferred** — Stories 2.2, 2.3, 2.4, 2.5, 2.6 all deferred frontend component tests. This is a growing coverage gap.
3. **E2E tests still missing** — No Playwright E2E tests written for any Epic 2 story. Integration test items remain unchecked.
4. **Story status mismatches** — Stories 2.1 and 2.6 show "review" in their files but "done" in sprint-status.yaml. Process gap.
5. **Not yet deployed** — Epic 2 code is complete but not deployed to any environment.
6. **Prisma schema naming inconsistency** — 5 models have `@@map` (snake_case tables), 14 models don't (PascalCase tables in PostgreSQL). Inconsistency accumulated over stories.

## Key Patterns Identified

### Gemini vs Claude Quality Correlation
- **Gemini stories** (1-1, 1-2, 1-3, 2-1): CRITICAL/HIGH review findings, security gaps, missing validations
- **Claude Opus stories** (2.2–2.6): Clean implementations, review findings were optimization/edge-case level
- **Implication**: Gemini-built foundations (auth, RBAC, tenant provisioning, course/class) underpin everything. They need a dedicated audit.

### Deferred Work Accumulation
- Frontend component tests deferred across 5 stories
- E2E tests deferred across 6 stories
- Virtual scrolling deferred (2.4)
- Rich text editor evaluation deferred (2.5)

### Code Review Effectiveness
- Story 2.3 review caught: missing RBAC, debug console.log, race condition, unimplemented handlers
- Story 2.5 review caught: stale useCallback, incorrect batch conflict check, unscoped room query
- Two-round reviews (2.3) produced the highest quality output

---

## Epic 1 Action Items Follow-Through

| # | Action Item | Status | Evidence |
|---|-------------|--------|----------|
| A1 | a11y linting (eslint-plugin-jsx-a11y) | NOT DONE | No evidence in any story |
| A2 | STAFF_ROLES constant | DONE | Used in multiple stories |
| A3 | Playwright browser setup | PARTIAL | apps/e2e/ exists but no Epic 2 tests |
| A4 | E2E for auth flows | NOT DONE | No auth E2E tests written |
| A5 | Standardize toast patterns | DONE | Consistent across stories |
| A6 | Aria labels | PARTIAL | Some stories mention it, not systematic |
| A7 | DB transaction for multi-table ops | DONE | Prisma transactions used in 2.5, 2.6 |
| A8 | Update project-context.md | PARTIAL | Updated but naming rules incomplete |
| A9 | Form validation patterns | DONE | Zod resolver + react-hook-form consistent |
| A10 | Loading states | DONE | Skeleton/spinner patterns adopted |
| A11 | Error boundary wrappers | NOT DONE | No error boundaries added |

**Score: 5/11 Done, 3/11 Partial, 3/11 Not Done**

---

## Epic 3 Preview

Epic 3 (IELTS Exercise Builder) has **16 stories** (3.1–3.16), the largest epic by far. It introduces:
- New domain models (Exercise, Passage, QuestionType, AnswerKey)
- File upload (audio for listening, PDF for AI generation)
- AI integration (content generation)
- Complex form builders (14+ question types)
- Timer/test condition system
- Exercise assignment and student dashboard

**Key Risk**: Epic 3 builds on the Gemini-built foundation code. Auth (1-2), RBAC (1-3), and course/class management (2-1) are touched by every route and component. If those foundations have latent issues, they'll multiply across 16 stories.

---

## Action Items

### P0 — Before Epic 3 Starts

| # | Action | Owner | Description |
|---|--------|-------|-------------|
| A1 | **Code audit: Gemini foundations** | Dev | Deep audit of stories 1-1, 1-2, 1-3, 2-1 code. Check for: security gaps, missing validations, incorrect patterns, test coverage. Fix or rewrite as needed. |
| A2 | **Unify Prisma table naming** | Dev | Add `@@map("snake_case")` to all 14 models missing it. Create migration. Rule added to project-context.md. |
| A3 | **Fix story status mismatches** | SM | Update story 2-1 and 2-6 files from "review" to "done" status. |

### P1 — During Epic 3

| # | Action | Owner | Description |
|---|--------|-------|-------------|
| A4 | **Frontend component tests** | Dev | Add Vitest component tests for Epic 2 features (WeeklyCalendar, CreateSessionDialog, ConflictWarningBanner, AttendanceSheet, SessionBlock). |
| A5 | **Deploy Epic 2** | Dev/Ops | Deploy Epic 2 to staging/production environment. |
| A6 | **E2E test foundation** | QA/Dev | Write first Playwright E2E tests covering core logistics flows (create class, schedule session, take attendance). |

### P2 — Carried Forward

| # | Action | Owner | Description |
|---|--------|-------|-------------|
| A7 | a11y linting setup | Dev | Install and configure eslint-plugin-jsx-a11y (carried from Epic 1) |
| A8 | Error boundary wrappers | Dev | Add React error boundaries to feature routes (carried from Epic 1) |
| A9 | Rich text editor evaluation | Dev | Evaluate TipTap/Lexical for Exercise Builder notes fields |
| A10 | Exercise data model design | Architect | Design Prisma schema for exercises, passages, question types before story 3.1 |

---

## Critical Path (Revised)

```
Code Audit (A1) + Prisma Naming (A2)
        ↓
  Epic 3 Story 3.1 (Exercise Builder Core)
        ↓
  Stories 3.2–3.5 (Reading question types)
        ↓
  Stories 3.6–3.9 (Listening, Writing, Speaking)
        ↓
  Stories 3.10–3.16 (Platform features)
```

**The code audit (A1) is the gate.** Epic 3 should not start until the Gemini-built foundations are verified or fixed.

---

## Readiness Assessment

| Dimension | Status | Notes |
|-----------|--------|-------|
| Gemini code foundations | BLOCKED | Audit required before Epic 3 |
| Frontend test coverage | GAP | No component tests for Epic 2 |
| E2E tests | GAP | No Playwright tests for logistics |
| Deployment | NOT DONE | Epic 2 not deployed |
| Schema consistency | GAP | 14 models missing @@map |
| Backend test coverage | GOOD | 241 tests, growing each story |
| Architecture patterns | GOOD | Consistent Route-Controller-Service |
| Multi-tenancy | GOOD | getTenantedClient enforced |

**Overall: NOT READY for Epic 3 until P0 items (A1, A2) are resolved.**

---

## Retrospective Metadata

- **Agent:** Claude Opus 4.6
- **Workflow:** `_bmad/bmm/workflows/4-implementation/retrospective`
- **Duration:** Interactive session
- **Participants:** Bob (SM), Ducdo (User/PO)
